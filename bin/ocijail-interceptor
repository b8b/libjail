#!/bin/sh

# __kotlin_script_installer__ 2>&-
# vim: syntax=kotlin
#    _         _   _ _                       _       _
#   | |       | | | (_)                     (_)     | |
#   | | _____ | |_| |_ _ __    ___  ___ _ __ _ _ __ | |_
#   | |/ / _ \| __| | | '_ \  / __|/ __| '__| | '_ \| __|
#   |   < (_) | |_| | | | | | \__ \ (__| |  | | |_) | |_
#   |_|\_\___/ \__|_|_|_| |_| |___/\___|_|  |_| .__/ \__|
#                         ______              | |
#                        |______|             |_|
v=2.1.0.26
p=org/cikit/kotlin_script/"$v"/kotlin_script-"$v".sh
url="${M2_CENTRAL_REPO:=https://repo1.maven.org/maven2}"/"$p"
kotlin_script_sh="${M2_LOCAL_REPO:-"$HOME"/.m2/repository}"/"$p"
if ! [ -r "$kotlin_script_sh" ]; then
  kotlin_script_sh="$(mktemp)" || exit 1
  fetch_cmd="$(command -v curl) -kfLSso" || \
    fetch_cmd="$(command -v fetch) --no-verify-peer -aAqo" || \
    fetch_cmd="wget --no-check-certificate -qO"
  if ! $fetch_cmd "$kotlin_script_sh" "$url"; then
    echo "failed to fetch kotlin_script.sh from $url" >&2
    rm -f "$kotlin_script_sh"; exit 1
  fi
  dgst_cmd="$(command -v openssl) dgst -sha256 -r" || dgst_cmd=sha256sum
  case "$($dgst_cmd < "$kotlin_script_sh")" in
  "04126ed68e3dad3f077458c00cb4a4a06ac8b8df45666208af8497f822a0094a "*) ;;
  *) echo "error: failed to verify kotlin_script.sh" >&2
     rm -f "$kotlin_script_sh"; exit 1;;
  esac
fi

PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin

# resolve links - $0 may be a softlink
PRG="$0"

while [ -h "$PRG" ]; do
  ls="$(ls -ld "$PRG")"
  link="$(expr "$ls" : '.*-> \(.*\)$')"
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG="${PRG%/*}"/"$link"
  fi
done

BINDIR="${PRG%/*}"
ROOTDIR="${BINDIR%/*}"

if [ "$ROOTDIR" = "$BINDIR" ]; then
  ROOTDIR="$BINDIR"/..
fi

if [ -x "$ROOTDIR"/jre/bin/java ]; then
  java_cmd="$ROOTDIR"/jre/bin/java
elif [ -x /usr/local/openjdk22/bin/java ]; then
  java_cmd=/usr/local/openjdk22/bin/java
fi

if [ -x "$java_cmd" ]; then
  export java_cmd="$java_cmd"
fi

export M2_LOCAL_REPO="$ROOTDIR"/lib

set -- --oci-runtime-bin=/usr/local/bin/ocijail "$@"

. "$kotlin_script_sh"; exit 2

///PLUGIN=org.jetbrains.kotlin:kotlin-serialization-compiler-plugin-embeddable

///DEP=org.jetbrains.kotlinx:kotlinx-coroutines-core-jvm:1.10.1

///DEP=org.jetbrains.kotlinx:kotlinx-serialization-json-jvm:1.8.1
///DEP=org.jetbrains.kotlinx:kotlinx-serialization-core-jvm:1.8.1

///DEP=com.github.ajalt.clikt:clikt-jvm:5.0.3
///DEP=com.github.ajalt.clikt:clikt-core-jvm:5.0.3
///DEP=com.github.ajalt.mordant:mordant-jvm:3.0.2
///DEP=com.github.ajalt.mordant:mordant-core-jvm:3.0.2
///DEP=com.github.ajalt.colormath:colormath-jvm:3.6.0
///RDEP=com.github.ajalt.mordant:mordant-jvm-jna-jvm:3.0.2
///DEP=net.java.dev.jna:jna:5.14.0
///RDEP=com.github.ajalt.mordant:mordant-jvm-ffm-jvm:3.0.2
///RDEP=com.github.ajalt.mordant:mordant-jvm-graal-ffi-jvm:3.0.2

///RDEP=org.slf4j:slf4j-simple:2.0.13
///DEP=org.slf4j:slf4j-api:2.0.13

///DEP=io.ktor:ktor-network-jvm:3.1.2
///DEP=io.ktor:ktor-utils-jvm:3.1.2
///DEP=io.ktor:ktor-io-jvm:3.1.2
///DEP=org.jetbrains.kotlinx:kotlinx-io-core-jvm:0.6.0
///DEP=org.jetbrains.kotlinx:kotlinx-io-bytestring-jvm:0.6.0

///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/jail/ocijail.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/jail/cleanup.kt

///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/GenericInterceptor.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/OciCommand.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/OciConfig.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/OciLogger.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/OciRuntimeCommand.kt

///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/CreateCommand.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/DeleteCommand.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/ExecCommand.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/KillCommand.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/ListCommand.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/StartCommand.kt
///INC=../oci-interceptor/src/main/kotlin/org/cikit/oci/StateCommand.kt

///INC=../libjail/src/main/kotlin/org/cikit/libjail/jail.kt
///INC=../libjail/src/main/kotlin/org/cikit/libjail/kill.kt
///INC=../libjail/src/main/kotlin/org/cikit/libjail/mount.kt
///INC=../libjail/src/main/kotlin/org/cikit/libjail/sysctl.kt
///INC=../libjail/src/main/kotlin/org/cikit/libjail/util.kt
///INC=../libjail/src/main/kotlin/org/cikit/libjail/vmm.kt
///INC=../libjail/src/main/kotlin/org/cikit/libjail/vnet.kt

///MAIN=org.cikit.oci.jail.OciJailInterceptor
